#!/usr/bin/env bash

# -----------------------------------------------------------------------------

if [[ $EUID == 0 ]]; then
   echo "This script must be run as non-root user inside docker group"
   exit 1
fi

# -----------------------------------------------------------------------------

# Locate

if ( which realpath ); then
  SCRIPT_PATH=$(dirname "$(realpath -s "${BASH_SOURCE[0]}")")
else
  SCRIPT_PATH="$( cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 ; pwd -P )"
fi

DOCKER_PATH=$(dirname ${SCRIPT_PATH})
echo $DOCKER_PATH

# -----------------------------------------------------------------------------

COURSE_CONTAINER=test-cpp-course
COURSE_WORKSPACE=/workspace

# -----------------------------------------------------------------------------

MOUNT_PATH=$(dirname $(dirname "${DOCKER_PATH}"))
export MOUNT_PATH
echo "Mounting from $MOUNT_PATH"

export CONT_UID=$(id -u)
export CONT_GID=$(id -g)

docker-compose -f "${DOCKER_PATH}"/docker-compose.yml up -d --build --force-recreate

docker exec -it $COURSE_CONTAINER groupadd -g $(id -g) grp
docker exec -it $COURSE_CONTAINER useradd -u $(id -u) -g $(id -g) -m $USER
docker exec -it $COURSE_CONTAINER chown -R $USER $COURSE_WORKSPACE
